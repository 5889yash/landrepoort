<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Farmer Profiles</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        .container {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .profile-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }
        .profile-card h2 {
            color: #007bff;
            margin-bottom: 1rem;
            font-size: 1.75rem;
        }
        .profile-card h3 {
            color: #6c757d;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        .farmer-details p {
            margin-bottom: 0.5rem;
        }
        .table-responsive {
            margin-top: 1rem;
        }
        .table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        .table tbody tr:hover {
            background-color: #f2f2f2;
        }
        .khewat-no-cell {
            word-break: break-word;
        }
        .btn-print {
            margin-bottom: 1.5rem;
        }

        /* Filter Section Styles */
        .card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        .card-header {
            border-bottom: 1px solid #dee2e6;
        }
        .card-header h5 {
            color: #495057;
            font-weight: 600;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        /* Hidden class for filtering */
        .farmer-card-hidden {
            display: none !important;
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 1cm; /* Smaller margins for more content */
            }
            body {
                background-color: #fff;
                font-size: 9pt; /* Slightly smaller font for more content */
                color: #000;
            }
            .container {
                padding: 0;
            }
            .profile-card {
                box-shadow: none;
                border: 1px solid #dee2e6;
                margin-bottom: 1rem;
                page-break-inside: avoid; /* Avoid breaking cards across pages */
                page-break-after: always; /* Each farmer profile starts on a new page */
                padding: 1rem; /* Adjust padding for print */
            }
            .profile-card h2, .profile-card h3 {
                color: #000;
                font-size: 1.2em; /* Adjust heading sizes */
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .farmer-details .col-md-6 {
                flex: 0 0 50%; /* Force two columns for farmer details */
                max-width: 50%;
            }
            .farmer-details p {
                margin-bottom: 0.2rem;
            }
            .btn-print {
                display: none;
            }
            /* Hide filter section during printing */
            .card.mb-4 {
                display: none !important;
            }
            .table {
                width: 100%;
                margin-bottom: 1rem;
                color: #212529;
                border-collapse: collapse;
                font-size: 8pt; /* Smaller font for table content */
            }
            .table th, .table td {
                padding: 0.4rem; /* Smaller padding for table cells */
                vertical-align: top;
                border: 1px solid #dee2e6;
            }
            .table thead th {
                vertical-align: bottom;
                border-bottom: 2px solid #dee2e6;
            }
            .table-responsive {
                overflow-x: visible !important; /* Ensure table is fully visible in print */
            }
            /* Ensure all content within profile-card is visible */
            .profile-card .row {
                display: flex;
                flex-wrap: wrap;
            }
            .profile-card .col-md-6 {
                width: 50%;
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center text-primary">Farmer Land Records</h1>

        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Filter Farmers</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by name, father's name, mobile, or aadhar...">
                    </div>
                    <div class="col-md-3">
                        <label for="villageFilter" class="form-label">Village</label>
                        <select class="form-select" id="villageFilter">
                            <option value="">All Villages</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sourceFilter" class="form-label">Source API</label>
                        <select class="form-select" id="sourceFilter">
                            <option value="">All Sources</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <label for="districtFilter" class="form-label">District/City</label>
                        <select class="form-select" id="districtFilter">
                            <option value="">All Districts</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="areaFilter" class="form-label">Area Range</label>
                        <select class="form-select" id="areaFilter">
                            <option value="">All Areas</option>
                            <option value="non-zero">Non-Zero Acres</option>
                            <option value="0-1">0-1 Acres</option>
                            <option value="1-5">1-5 Acres</option>
                            <option value="5-10">5-10 Acres</option>
                            <option value="10-25">10-25 Acres</option>
                            <option value="25+">25+ Acres</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" id="clearFilters">
                            <i class="bi bi-x-circle me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="text-muted" id="filterCount">Showing all farmers</span>
                </div>
            </div>
        </div>

        <button class="btn btn-primary btn-print" onclick="window.print()">
            <i class="bi bi-printer-fill me-2"></i> Print All Profiles
        </button>

        {% for farmer in farmers %}
            <div class="profile-card farmer-card"
                 data-farmer-name="{{ farmer.farmer_name|lower }}"
                 data-father-name="{{ farmer.father_name|lower }}"
                 data-grandfather-name="{{ farmer.grandfather_name|lower }}"
                 data-mobile="{{ farmer.mobile_number|lower }}"
                 data-aadhar="{{ farmer.aadhar_number|lower }}"
                 data-village="{{ farmer.village_name|lower }}"
                 data-source="{{ farmer.source_api|lower }}"
                 data-total-area="{{ farmer.total_area_acres|round(2) }}"
                 data-districts="{% for land in farmer.lands %}{{ land.district_name|lower }}{% if not loop.last %} {% endif %}{% endfor %}"
                 data-cities="{% for land in farmer.lands %}{{ land.city_name|lower }}{% if not loop.last %} {% endif %}{% endfor %}"
                 data-search-text="{{ farmer.farmer_name|lower }} {{ farmer.father_name|lower }} {{ farmer.mobile_number|lower }} {{ farmer.aadhar_number|lower }}">
                <h2 class="mb-3">{{ farmer.farmer_name }}</h2>
                <div class="row farmer-details">
                    <div class="col-md-6">
                        <p><strong>Father's Name:</strong> {{ farmer.father_name }}</p>
                        <p><strong>Grandfather's Name:</strong> {{ farmer.grandfather_name }}</p>
                        <p><strong>Mobile:</strong> {{ farmer.mobile_number }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Aadhar:</strong> {{ farmer.aadhar_number }}</p>
                        <p><strong>Village:</strong> {{ farmer.village_name }}</p>
                        <p><strong>FIRM:</strong> {{ farmer.source_api }}</p>
                    </div>
                </div>

                <h3 class="mt-4">Land Ownership Summary</h3>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Total Land Records:</strong> {{ farmer.lands|length }}</p>
                    </div>
                <div class="col-md-6">
                    <p><strong>Total Area (Acres):</strong> {{ "%.2f"|format(farmer.total_area_acres) }}</p>
                </div>
            </div>

            {% if farmer.bank_detail %}
                <h3 class="mt-4">Bank Details</h3>
                <div class="row farmer-details">
                    <div class="col-md-6">
                        <p><strong>Account Holder:</strong> {{ farmer.bank_detail.account_holder_name }}</p>
                        <p><strong>Bank Name:</strong> {{ farmer.bank_detail.bank_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Account No:</strong> {{ farmer.bank_detail.account_no }}</p>
                        <p><strong>IFSC Code:</strong> {{ farmer.bank_detail.ifsc_code }}</p>
                        <p><strong>Branch Name:</strong> {{ farmer.bank_detail.branch_name }}</p>
                    </div>
                </div>
            {% else %}
                <p class="text-muted">No bank details available for this farmer.</p>
            {% endif %}

            {% if farmer.lands %}
                <h3 class="mt-4">Land Records</h3>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Sr. No.</th>
                                <th>Location</th>
                                <th>Khewat No.</th>
                                <th>Owner Name</th>
                                <th>Owner Area</th>
                                <th>Land Available for Mapping</th>
                                <th>Area under Cultivation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for land in farmer.lands %}
                                <tr>
                                    <td>{{ ++loop.index }}</td> {# Start Sr. No. from 1 #}
                                    <td>{{ land.village_name }}, {{ land.city_name }}, {{ land.district_name }}</td>
                                        <td class="khewat-no-cell">{{ land.khewat_no }}</td>
                                    <td>{{ land.owner_name }}</td>
                                    <td>{{ land.owner_area }}</td>
                                    <td>{{ land.kanal1 }}K {{ land.marle1 }}M {{ land.sarsai1 }}S</td>
                                    <td>{{ land.kanal }}K {{ land.marle }}M {{ land.sarsai }}S</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No land records available for this farmer.</p>
            {% endif %}
            </div>
        {% endfor %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const villageFilter = document.getElementById('villageFilter');
            const sourceFilter = document.getElementById('sourceFilter');
            const districtFilter = document.getElementById('districtFilter');
            const areaFilter = document.getElementById('areaFilter');
            const clearFiltersBtn = document.getElementById('clearFilters');
            const filterCount = document.getElementById('filterCount');
            const farmerCards = document.querySelectorAll('.farmer-card');

            // Collect unique values from data attributes
            const uniqueVillages = [...new Set(Array.from(farmerCards).map(card => card.dataset.village).filter(v => v))].sort();
            const uniqueSources = [...new Set(Array.from(farmerCards).map(card => card.dataset.source).filter(s => s))].sort();
            const uniqueDistricts = [...new Set(Array.from(farmerCards).map(card => card.dataset.districts).filter(d => d).join(' ').split(' ').filter(d => d))].sort();

            // Populate dropdowns
            populateDropdown(villageFilter, uniqueVillages);
            populateDropdown(sourceFilter, uniqueSources);
            populateDropdown(districtFilter, uniqueDistricts);

            // Add event listeners
            searchInput.addEventListener('input', applyFilters);
            villageFilter.addEventListener('change', applyFilters);
            sourceFilter.addEventListener('change', applyFilters);
            districtFilter.addEventListener('change', applyFilters);
            areaFilter.addEventListener('change', applyFilters);
            clearFiltersBtn.addEventListener('click', clearAllFilters);

            function populateDropdown(dropdown, options) {
                options.forEach(option => {
                    if (option) {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.toLowerCase();
                        optionElement.textContent = option;
                        dropdown.appendChild(optionElement);
                    }
                });
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedVillage = villageFilter.value.toLowerCase();
                const selectedSource = sourceFilter.value.toLowerCase();
                const selectedDistrict = districtFilter.value.toLowerCase();
                const selectedArea = areaFilter.value;

                let visibleCount = 0;

                farmerCards.forEach(card => {
                    let shouldShow = true;

                    // Search filter
                    if (searchTerm) {
                        const searchText = card.dataset.searchText;
                        shouldShow = searchText.includes(searchTerm);
                    }

                    // Village filter
                    if (shouldShow && selectedVillage) {
                        shouldShow = card.dataset.village.includes(selectedVillage);
                    }

                    // Source filter
                    if (shouldShow && selectedSource) {
                        shouldShow = card.dataset.source.includes(selectedSource);
                    }

                    // District filter
                    if (shouldShow && selectedDistrict) {
                        shouldShow = card.dataset.districts.includes(selectedDistrict);
                    }

                    // Area filter
                    if (shouldShow && selectedArea) {
                        const area = parseFloat(card.dataset.totalArea);
                        switch(selectedArea) {
                            case 'non-zero':
                                shouldShow = area > 0;
                                break;
                            case '0-1':
                                shouldShow = area >= 0 && area <= 1;
                                break;
                            case '1-5':
                                shouldShow = area > 1 && area <= 5;
                                break;
                            case '5-10':
                                shouldShow = area > 5 && area <= 10;
                                break;
                            case '10-25':
                                shouldShow = area > 10 && area <= 25;
                                break;
                            case '25+':
                                shouldShow = area > 25;
                                break;
                        }
                    }

                    if (shouldShow) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Update filter count
                updateFilterCount(visibleCount);
            }

            function updateFilterCount(count) {
                const total = farmerCards.length;
                if (count === total) {
                    filterCount.textContent = `Showing all ${total} farmers`;
                } else {
                    filterCount.textContent = `Showing ${count} of ${total} farmers`;
                }
            }

            function clearAllFilters() {
                searchInput.value = '';
                villageFilter.value = '';
                sourceFilter.value = '';
                districtFilter.value = '';
                areaFilter.value = '';

                farmerCards.forEach(card => {
                    card.style.display = 'block';
                });

                updateFilterCount(farmerCards.length);
            }

            // Initial filter count
            updateFilterCount(farmerCards.length);
        });
    </script>
</body>
</html>
